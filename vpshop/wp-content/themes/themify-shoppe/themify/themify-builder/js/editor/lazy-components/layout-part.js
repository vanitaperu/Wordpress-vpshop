((t,e,i,s,a)=>{"use strict";t.LayoutPart=class{static cache={};constructor(t){this.id=t}edit(){const o=this.id,r=this.constructor.cache;return new Promise((async(l,_)=>{const d=t.Registry.get(o);if(!d)return void _();await t.LightBox.save(),t.ActionBar.clear();let h=d.el.closest(".active_module"),c=h.tfClass("themify_builder_content")[0],n=c.dataset.postid,u=async()=>{i.body.classList.add("tb_layout_part_edit"),a.document.body.classList.add("tb_layout_part_edit"),t.ToolBar.el.classList.add("tb_layout_part_edit");const o=t.Builder.get(),d=s("","tb_overlay tf_overflow tf_abs tf_w tf_h");i.body.appendChild(d);const u=[];for(let t=i.tfClass("themify_builder_content-"+n),e=t.length-1;e>-1;--e)t[e].closest(".active_module")?.tfClass("themify-builder-generated-css")[0]?.setAttribute("disabled","disabled");o.el.classList.remove("tb_active_builder"),h.classList.add("tb_active_layout_part"),h.classList.remove("active_module","module");const b=h.closest(".tb_holder"),y=c.offsetHeight;b.classList.add("tb_layout_part_parent"),b.classList.remove("tb_holder"),b.closest(".module_row").classList.add("tb_active_layout_part_row"),this.el=h;let f=new t.Builder(c,t.Helper.correctBuilderData(r[n].builder_data),r[n].custom_css);for(let t=f.el.querySelectorAll("[data-cid]"),e=t.length-1;e>-1;--e)u.push(t[e].dataset.cid);f.el.style.height=y+"px";for(let t=f.el.children,e=t.length-1;e>-1;--e)t[e].dataset.cid||t[e].remove();try{await t.bootstrap(u),f.el.style.height="";try{await t.correctColumnPaddings()}catch(t){}t.Utils.runJs(f.el),t.Registry.trigger(f,"tb_init"),await t.Spinner.showLoader("done"),this.toolbar.getRootNode().host.classList.remove("tf_hide"),t.activeModel=null,this.toolbar.tfOn(e.click,(e=>{e.stopPropagation();const i=e.target;i.closest("a")&&e.preventDefault(),i.closest(".tf_close")?this.close():i.closest(".save")?this.save():i.closest(".layout")?t.ToolBar.initLayout(e):i.closest(".import")?t.ToolBar.initImport(e):i.closest(".export")?t.ToolBar.initExport(e):i.closest(".undo_redo")?t.undoManager.doChange(e):i.closest(".custom_css")&&t.ToolBar.addCustomCSS(e)}));const s=[],a=t.undoManager;for(let e=a.stack,i=0;i<e.length;++i)s[i]=t.Helper.cloneObject(e[i]);this.undo=s,a.btnUndo=this.toolbar.tfClass("undo")[0],a.btnRedo=this.toolbar.tfClass("redo")[0],a.reset(),h=f=c=n=null,e.isTouch||d.tfOn("dblclick",(t=>{t.preventDefault(),t.stopImmediatePropagation(),this.save().then((()=>{this.close()}))}),{once:!0}),i.tfId("tb_layout_part_ui")?.removeAttribute("disabled"),l()}catch(e){t.Spinner.showLoader("error"),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}},b=()=>{this.html=t.Helper.cloneDom(h).innerHTML;const e=s("",{id:"tb_small_toolbar_root",class:"tb_disable_sorting tf_w tf_hide"}),a=i.tfId("tmpl-small_toolbar"),o=i.createDocumentFragment(),r=t.ToolBar.el.getRootNode().querySelectorAll("style,#module_toolbar_style,#tf_svg");e.attachShadow({mode:"open"}).appendChild(a.content.cloneNode(!0));for(let t=0;t<r.length;++t)o.appendChild(r[t].cloneNode(!0));e.shadowRoot.prepend(o),this.toolbar=e.shadowRoot.tfId("toolbar"),h.prepend(e)};try{if(void 0===r[n]){const e=await t.LocalFetch({action:"tb_layout_part_swap",bid:n});if(!e.builder_data)throw"Error";r[n]=e,e.used_gs&&(t.GS.styles={...t.GS.styles,...e.used_gs})}b(),u()}catch(e){t.Spinner.showLoader("error"),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}}))}restore(){this.toolbar.getRootNode().host.remove(),t.LightBox.close();const s=this.el.closest(".tb_layout_part_parent"),o=t.Builder.get();this.el.classList.add("active_module","module"),this.el.classList.remove("tb_active_layout_part"),s.classList.add("tb_holder"),s.classList.remove("tb_layout_part_parent"),s.closest(".module_row").classList.remove("tb_active_layout_part_row"),o.destroy(),i.tfClass("tb_overlay")[0]?.remove(),t.undoManager.stack=this.undo,t.undoManager.index=this.undo.length-1,t.undoManager.btnUndo=t.ToolBar.el.tfClass("undo")[0],t.undoManager.btnRedo=t.ToolBar.el.tfClass("redo")[0],t.undoManager.updateUndoBtns(),t.ActionBar.clear(),t.Builder.get().el.classList.add("tb_active_builder","tf_rel"),i.tfId("tb_layout_part_ui").disabled=!0,i.body.classList.remove("tb_layout_part_edit"),a.document.body.classList.remove("tb_layout_part_edit"),t.ToolBar.el.classList.remove("tb_layout_part_edit"),e.trigger("tb_resotre_layout_part"),this.undo=this.html=this.el=t.activeModel=this.cssFile=t.LayoutPart.item=null}async close(){if(!1===t.Builder.get().isSaved&&t.undoManager.hasUndo()){if("yes"!==await t.LiteLightBox.confirm({msg:"layoutEditConfirm"}))return!1}const e="themify_builder_content-"+t.Builder.get().id;if(this.cssFile){t.Spinner.showLoader();const a=t.Registry.get(this.el.dataset.cid);try{await a.visualPreview({unsetKey:!0,...a.get("mod_settings")});const o=a.el.tfClass("themify_builder_content")[0].innerHTML;let r;!0!==this.cssFile&&(r=s("link",{href:this.cssFile,rel:"stylesheet",class:"themify-builder-generated-css"})),this.restore();for(let s=i.tfClass(e),l=s.length-1;l>-1;--l){let e=s[l].closest(".module");for(let t=s[l].children,e=t.length-1;e>-1;--e)"LINK"===t[e].tagName&&t[e].classList.contains("themify-builder-generated-css")&&t[e].remove();r&&e.prepend(r.cloneNode(!0)),a.id!==e.dataset.cid&&(s[l].innerHTML=o,t.Utils.runJs(s[l]))}t.Spinner.showLoader("hide")}catch(e){throw t.Spinner.showLoader("error"),e}}else{this.html&&(this.el.innerHTML=this.html),this.restore();for(let t=i.tfClass(e),s=t.length-1;s>-1;--s)t[s].closest(".active_module")?.tfClass("themify-builder-generated-css")[0]?.removeAttribute("disabled");t.Utils.runJs(this.el)}}async save(){const e=this.toolbar.tfClass("save_wrap")[0].classList;try{if(e.contains("disabled"))throw"isWorking";e.add("disabled"),await t.LightBox.save(),t.Spinner.showLoader();const i=t.Builder.get(),s=i.id,a=this.constructor.cache,o=await i.save();a[s]={builder_data:o.builder_data},i.custom_css&&(a[s].custom_css=i.custom_css),this.cssFile=o.css_file||!0,this.html=null}catch(t){}e.remove("disabled")}},t.OverlayContent=class extends t.LayoutPart{constructor(t){super(t)}}})(tb_app,Themify,document,tb_createElement,window.top);